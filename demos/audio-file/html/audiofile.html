<!DOCTYPE html>
<html>
    <head>
        <title>Audio File Decoding Demo</title>
        
        <link rel="stylesheet" type="text/css" href="../css/audiofile.css" />
        
        <script src="../../../flocking/flocking-core.js"></script>
        <script src="../../../flocking/flocking-parser.js"></script>
        <script src="../../../flocking/flocking-audiofile.js"></script>
        <script src="../../../flocking/flocking-gfx.js"></script>
        
        <script src="../../shared/js/demo-utils.js"></script>
    </head>
    
    <body>
        <h1>Audio File Decoding Demo</h1>
        
        <div class="controls">
            <form class="fileSelector">
                <label for="fileBrowser">Choose a sound file</label>
                <input id="fileBrowser" type="file" />
                <div id="filePath"></div>
                <button id="browse">Choose a sound file...</button>
            </form>
        
            <button id="playButton">Play</button>
        </div>
        <div class="view">
            <canvas id="waveform" height="200" width="960"></canvas>
        </div>
        
        <script type="text/javascript">
            // Will hold the buffer containing the decoded audio data.
            var soundBuffer;
            
            // Set up an empty scopeView widget, which will eventually show the waveform when it has loaded.
            var scope = flock.gfx.scopeView(document.getElementById("waveform"), {
                values: flock.generate(2000, 0)
            });
            
            // Bind a change listener on the file browser. Whenever a file is selected,
            // read it the contents of it into a new typed array and display it in the scope view.
            // TODO: Create a declarative buffer API for loading files.
            document.getElementById("fileBrowser").addEventListener("change", function () {
                var file = this.files[0];
                document.getElementById("filePath").innerHTML = file.name;
                var reader = new FileReader();
                reader.onload = function (e) {
                    // Decode the audio file.
                    var data = e.target.result;
                    var name = file.name;
                    var type = name.substring(name.lastIndexOf(".") + 1);
                    var decoded = flock.audio.decode(type, data);
                    soundBuffer = decoded.channels[0].subarray(0, 44100 * 5); // Just the first five seconds of the first channel.
                    
                    // Display it in the scope view.
                    scope.model.values = soundBuffer;
                    scope.refreshView();
                };
                reader.readAsBinaryString(file);
            }, false);
            
            // Bind a click event to the browse button, which delegates to the hidden (ugly) file input element.
            document.getElementById("browse").addEventListener("click", function (e) {
                document.getElementById("fileBrowser").click();
                e.preventDefault();
            }, false);
            
            // Play the audio buffer to the speakers.
            // TODO: Refactor this into a real ugen.
            document.getElementById("playButton").addEventListener("click", function (e) {
                var a = new Audio();
                a.mozSetup(1, 44100);
                a.mozWriteAudio(soundBuffer);
                e.preventDefault();
            });
        </script>
    </body>
</html>
