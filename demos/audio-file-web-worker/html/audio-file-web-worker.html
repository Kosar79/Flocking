<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Decoding Audio in a Web Worker</title>
        
        <script src="../../../third-party/polydataview/js/polydataview.js"></script>
        <script src="../../../third-party/jquery/js/jquery-2.0.0.js"></script>
        <script src="../../../third-party/infusion/js/Fluid.js"></script>
        <script src="../../../third-party/infusion/js/FluidIoC.js"></script>
        <script src="../../../third-party/infusion/js/DataBinding.js"></script>
        
        <script src="../../../flocking/flocking-core.js"></script>
        <script src="../../../flocking/flocking-scheduler.js"></script>
        <script src="../../../flocking/flocking-firefox.js"></script>
        <script src="../../../flocking/flocking-webaudio.js"></script>
        <script src="../../../flocking/flocking-parser.js"></script>
        <script src="../../../flocking/flocking-ugens.js"></script>
    </head>
    <body>
        <audio src="http://tts.idrc.ocadu.ca/?q=eat%20it,%20cat" controls="true" />
        
        <script>
            flock.init();
            fluid.registerNamespace("demo");
            
            var worker = new Worker("../js/decode-audio-worker.js");
            worker.onmessage = function (e) {
                if (e.data.msg === "afterDecoded") {
                    demo.playBuffer(e.data.buffer);
                }
            };
            
            worker.postMessage({
                msg: "decode",
                url: "hillier-first-chord.wav"
            });
            
            demo.playBuffer = function (buffer) {
                var enviro = flock.enviro.shared;
                
                // Dump any currently-playing nodes from the environment.
                if (enviro.nodes > 0) {
                    enviro.reset();
                }
                
                enviro.play();
                                
                var s = flock.synth({
                    synthDef: {
                        ugen: "flock.ugen.playBuffer",
                        buffer: buffer.data.channels[0]
                    }
                });
            };
            
        </script>
    </body>
</html>